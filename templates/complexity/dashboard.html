{% extends 'base.html' %}

{% block title %}Narrative Complexity Dashboard{% endblock %}

{% block head %}
{{ super() }}
<style>
    .score-pill {
        font-size: 0.8rem;
        padding: 0.2rem 0.4rem;
        border-radius: 1rem;
        display: inline-block;
        width: 36px;
        text-align: center;
        font-weight: bold;
    }
    .score-high {
        background-color: var(--bs-danger-bg-subtle);
        color: var(--bs-danger);
    }
    .score-medium {
        background-color: var(--bs-warning-bg-subtle);
        color: var(--bs-warning-text);
    }
    .score-low {
        background-color: var(--bs-success-bg-subtle);
        color: var(--bs-success);
    }
    .dashboard-header {
        margin-bottom: 1.5rem;
    }
    .table th {
        font-size: 0.85rem;
        border-bottom-width: 2px;
    }
    .title-cell {
        max-width: 300px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .chart-container {
        position: relative;
        height: 350px;
        margin-bottom: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="dashboard-header">
        <h1>Narrative Complexity Dashboard</h1>
        <p class="text-muted">Analyze and compare narrative complexity dimensions across active misinformation narratives.</p>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Overall Complexity Distribution</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="complexityDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Complexity Dimension Comparison</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="dimensionComparisonChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5>Narrative Complexity Overview</h5>
        </div>
        <div class="card-body">
            {% if narratives %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Title</th>
                            <th>Overall</th>
                            <th>Linguistic</th>
                            <th>Logical</th>
                            <th>Rhetorical</th>
                            <th>Emotional</th>
                            <th>Last Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for narrative in narratives %}
                        <tr>
                            <td>{{ narrative.id }}</td>
                            <td class="title-cell" title="{{ narrative.title }}">{{ narrative.title }}</td>
                            <td>
                                <span class="score-pill 
                                    {% if narrative.overall_score >= 7 %}score-high
                                    {% elif narrative.overall_score >= 4 %}score-medium
                                    {% else %}score-low{% endif %}">
                                    {{ narrative.overall_score }}
                                </span>
                            </td>
                            <td>
                                <span class="score-pill 
                                    {% if narrative.linguistic_score >= 7 %}score-high
                                    {% elif narrative.linguistic_score >= 4 %}score-medium
                                    {% else %}score-low{% endif %}">
                                    {{ narrative.linguistic_score }}
                                </span>
                            </td>
                            <td>
                                <span class="score-pill 
                                    {% if narrative.logical_score >= 7 %}score-high
                                    {% elif narrative.logical_score >= 4 %}score-medium
                                    {% else %}score-low{% endif %}">
                                    {{ narrative.logical_score }}
                                </span>
                            </td>
                            <td>
                                <span class="score-pill 
                                    {% if narrative.rhetorical_score >= 7 %}score-high
                                    {% elif narrative.rhetorical_score >= 4 %}score-medium
                                    {% else %}score-low{% endif %}">
                                    {{ narrative.rhetorical_score }}
                                </span>
                            </td>
                            <td>
                                <span class="score-pill 
                                    {% if narrative.emotional_score >= 7 %}score-high
                                    {% elif narrative.emotional_score >= 4 %}score-medium
                                    {% else %}score-low{% endif %}">
                                    {{ narrative.emotional_score }}
                                </span>
                            </td>
                            <td>{{ narrative.last_updated.strftime('%Y-%m-%d') }}</td>
                            <td>
                                <a href="/complexity/view/{{ narrative.id }}" class="btn btn-sm btn-outline-primary">View</a>
                                <a href="/narratives/view/{{ narrative.id }}" class="btn btn-sm btn-outline-secondary">Narrative</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                <p>No narratives with complexity analysis data are available yet.</p>
                <p>Please use the batch analysis feature or analyze individual narratives.</p>
            </div>
            {% endif %}
        </div>
    </div>

    {% if current_user.role == 'admin' %}
    <div class="card mb-4">
        <div class="card-header">
            <h5>Batch Analysis</h5>
        </div>
        <div class="card-body">
            <form id="batch-analysis-form">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="days" class="form-label">Days back to analyze</label>
                            <input type="number" class="form-control" id="days" name="days" min="1" max="30" value="7">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="limit" class="form-label">Maximum narratives to analyze</label>
                            <input type="number" class="form-control" id="limit" name="limit" min="1" max="100" value="20">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mt-4 pt-2">
                            <button type="submit" class="btn btn-primary" id="batch-analyze-btn">
                                Run Batch Analysis
                            </button>
                        </div>
                    </div>
                </div>
            </form>
            <div id="batch-loading" style="display: none;">
                <div class="d-flex justify-content-center mt-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <p class="text-center mt-2">Processing batch analysis. This may take several minutes...</p>
            </div>
            <div id="batch-result" class="mt-3" style="display: none;"></div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if narratives %}
        // Prepare data for charts
        const narrativesData = {{ narratives | tojson }};
        
        // Overall complexity distribution
        const complexityScores = narrativesData.map(n => n.overall_score);
        const lowCount = complexityScores.filter(s => s < 4).length;
        const mediumCount = complexityScores.filter(s => s >= 4 && s < 7).length;
        const highCount = complexityScores.filter(s => s >= 7).length;
        
        const ctxDistribution = document.getElementById('complexityDistributionChart').getContext('2d');
        new Chart(ctxDistribution, {
            type: 'pie',
            data: {
                labels: ['Low Complexity (1-3)', 'Medium Complexity (4-6)', 'High Complexity (7-10)'],
                datasets: [{
                    data: [lowCount, mediumCount, highCount],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.7)',
                        'rgba(255, 193, 7, 0.7)',
                        'rgba(220, 53, 69, 0.7)'
                    ],
                    borderColor: [
                        'rgba(40, 167, 69, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(220, 53, 69, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // Dimension comparison chart
        const avgLinguistic = narrativesData.reduce((sum, n) => sum + n.linguistic_score, 0) / narrativesData.length;
        const avgLogical = narrativesData.reduce((sum, n) => sum + n.logical_score, 0) / narrativesData.length;
        const avgRhetorical = narrativesData.reduce((sum, n) => sum + n.rhetorical_score, 0) / narrativesData.length;
        const avgEmotional = narrativesData.reduce((sum, n) => sum + n.emotional_score, 0) / narrativesData.length;
        
        const ctxDimension = document.getElementById('dimensionComparisonChart').getContext('2d');
        new Chart(ctxDimension, {
            type: 'bar',
            data: {
                labels: ['Linguistic', 'Logical', 'Rhetorical', 'Emotional'],
                datasets: [{
                    label: 'Average Score',
                    data: [
                        avgLinguistic.toFixed(1), 
                        avgLogical.toFixed(1), 
                        avgRhetorical.toFixed(1), 
                        avgEmotional.toFixed(1)
                    ],
                    backgroundColor: [
                        'rgba(13, 110, 253, 0.7)',
                        'rgba(25, 135, 84, 0.7)',
                        'rgba(255, 193, 7, 0.7)',
                        'rgba(220, 53, 69, 0.7)'
                    ],
                    borderColor: [
                        'rgba(13, 110, 253, 1)',
                        'rgba(25, 135, 84, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(220, 53, 69, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        title: {
                            display: true,
                            text: 'Average Score'
                        }
                    }
                }
            }
        });
        {% endif %}
        
        // Batch analysis form handler
        const batchForm = document.getElementById('batch-analysis-form');
        if (batchForm) {
            batchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const days = document.getElementById('days').value;
                const limit = document.getElementById('limit').value;
                
                // Show loading indicator
                document.getElementById('batch-loading').style.display = 'block';
                document.getElementById('batch-result').style.display = 'none';
                
                // Call API to run batch analysis
                fetch('/complexity/batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        days: parseInt(days),
                        limit: parseInt(limit)
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || 'Batch analysis failed'); });
                    }
                    return response.json();
                })
                .then(data => {
                    // Hide loading indicator
                    document.getElementById('batch-loading').style.display = 'none';
                    
                    // Show result
                    const resultElement = document.getElementById('batch-result');
                    resultElement.style.display = 'block';
                    resultElement.innerHTML = `
                        <div class="alert alert-success">
                            <h5>Batch Analysis Complete</h5>
                            <p>Successfully analyzed ${data.total_analyzed} narratives.</p>
                            <p>Refresh the page to see updated results in the dashboard.</p>
                            <button class="btn btn-success mt-2" onclick="window.location.reload()">Refresh Dashboard</button>
                        </div>
                    `;
                })
                .catch(error => {
                    // Hide loading indicator
                    document.getElementById('batch-loading').style.display = 'none';
                    
                    // Show error
                    const resultElement = document.getElementById('batch-result');
                    resultElement.style.display = 'block';
                    resultElement.innerHTML = `
                        <div class="alert alert-danger">
                            <h5>Error Running Batch Analysis</h5>
                            <p>${error.message}</p>
                        </div>
                    `;
                });
            });
        }
    });
</script>
{% endblock %}