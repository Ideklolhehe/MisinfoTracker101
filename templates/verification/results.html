{% extends "base.html" %}

{% block title %}Verification Results | CIVILIAN{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('verification.index') }}">Verification</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Results</li>
                </ol>
            </nav>
            
            <h1>Verification Results</h1>
            <p class="lead">
                Analysis of your submitted content is complete. Review the detailed findings below.
            </p>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h4 class="mb-0">Submitted Content</h4>
                </div>
                <div class="card-body">
                    <h5>{{ submission.title or 'Untitled Submission' }}</h5>
                    
                    {% if submission.description %}
                        <div class="mb-3">
                            <strong>Description:</strong>
                            <p>{{ submission.description }}</p>
                        </div>
                    {% endif %}
                    
                    {% if submission.content_type in ['text', 'text_image', 'text_video'] and submission.text_content %}
                        <div class="mb-3">
                            <strong>Text Content:</strong>
                            <div class="p-3 bg-light rounded">
                                <p>{{ submission.text_content }}</p>
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if submission.content_type in ['image', 'text_image'] and submission.media_path %}
                        <div class="mb-3">
                            <strong>Image:</strong>
                            <div class="text-center">
                                <img src="{{ url_for('static', filename=submission.media_path.replace('static/', '')) }}" 
                                     class="img-fluid rounded" 
                                     alt="Submitted image" 
                                     style="max-height: 400px;">
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if submission.content_type in ['video', 'text_video'] and submission.media_path %}
                        <div class="mb-3">
                            <strong>Video:</strong>
                            <div class="text-center">
                                <video controls class="img-fluid rounded" style="max-height: 400px;">
                                    <source src="{{ url_for('static', filename=submission.media_path.replace('static/', '')) }}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if submission.source_url %}
                        <div class="mb-3">
                            <strong>Source URL:</strong>
                            <a href="{{ submission.source_url }}" target="_blank" rel="noopener noreferrer">
                                {{ submission.source_url }}
                            </a>
                        </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">Submitted on: {{ submission.submitted_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                        <small class="text-muted">ID: {{ submission.id }}</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Verification Summary</h4>
                </div>
                <div class="card-body">
                    {% set misinformation_result = namespace(found=False, value=None) %}
                    {% set ai_generated_result = namespace(found=False, value=None) %}
                    {% set authenticity_result = namespace(found=False, value=None) %}
                    {% set factual_result = namespace(found=False, value=None) %}
                    
                    {% for result in verification_results %}
                        {% if result.verification_type == 'misinformation' and result.status == 'completed' %}
                            {% set misinformation_result.found = True %}
                            {% set misinformation_result.value = result %}
                        {% elif result.verification_type == 'ai_generated' and result.status == 'completed' %}
                            {% set ai_generated_result.found = True %}
                            {% set ai_generated_result.value = result %}
                        {% elif result.verification_type == 'authenticity' and result.status == 'completed' %}
                            {% set authenticity_result.found = True %}
                            {% set authenticity_result.value = result %}
                        {% elif result.verification_type == 'factual_accuracy' and result.status == 'completed' %}
                            {% set factual_result.found = True %}
                            {% set factual_result.value = result %}
                        {% endif %}
                    {% endfor %}
                    
                    <div class="verification-gauge mb-4">
                        {% set overall_score = 0 %}
                        {% set count = 0 %}
                        
                        {% if misinformation_result.found %}
                            {% set overall_score = overall_score + misinformation_result.value.confidence_score %}
                            {% set count = count + 1 %}
                        {% endif %}
                        
                        {% if ai_generated_result.found %}
                            {% set overall_score = overall_score + ai_generated_result.value.confidence_score %}
                            {% set count = count + 1 %}
                        {% endif %}
                        
                        {% if authenticity_result.found %}
                            {% set overall_score = overall_score + authenticity_result.value.confidence_score %}
                            {% set count = count + 1 %}
                        {% endif %}
                        
                        {% if factual_result.found %}
                            {% set overall_score = overall_score + factual_result.value.confidence_score %}
                            {% set count = count + 1 %}
                        {% endif %}
                        
                        {% if count > 0 %}
                            {% set avg_score = overall_score / count %}
                            
                            <div class="text-center">
                                <div class="h1 mb-2">
                                    {% if avg_score > 0.8 %}
                                        <span class="badge bg-danger">High Concern</span>
                                    {% elif avg_score > 0.5 %}
                                        <span class="badge bg-warning">Moderate Concern</span>
                                    {% elif avg_score > 0.2 %}
                                        <span class="badge bg-info">Low Concern</span>
                                    {% else %}
                                        <span class="badge bg-success">No Concern</span>
                                    {% endif %}
                                </div>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar 
                                        {% if avg_score > 0.8 %}bg-danger
                                        {% elif avg_score > 0.5 %}bg-warning
                                        {% elif avg_score > 0.2 %}bg-info
                                        {% else %}bg-success{% endif %}"
                                        role="progressbar" 
                                        style="width: {{ avg_score * 100 }}%"
                                        aria-valuenow="{{ avg_score * 100 }}" 
                                        aria-valuemin="0" 
                                        aria-valuemax="100">
                                        {{ "%.1f"|format(avg_score * 100) }}%
                                    </div>
                                </div>
                                <small class="text-muted">Overall credibility concern level</small>
                            </div>
                        {% else %}
                            <div class="alert alert-info text-center">
                                <i class="fas fa-spinner fa-spin"></i> Processing verification...
                            </div>
                        {% endif %}
                    </div>
                    
                    <ul class="list-group mb-3">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Misinformation</span>
                            {% if misinformation_result.found %}
                                {% if misinformation_result.value.confidence_score > 0.7 %}
                                    <span class="badge bg-danger rounded-pill">High</span>
                                {% elif misinformation_result.value.confidence_score > 0.4 %}
                                    <span class="badge bg-warning rounded-pill">Medium</span>
                                {% else %}
                                    <span class="badge bg-success rounded-pill">Low</span>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-secondary rounded-pill">Pending</span>
                            {% endif %}
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>AI Generated</span>
                            {% if ai_generated_result.found %}
                                {% if ai_generated_result.value.confidence_score > 0.7 %}
                                    <span class="badge bg-danger rounded-pill">High</span>
                                {% elif ai_generated_result.value.confidence_score > 0.4 %}
                                    <span class="badge bg-warning rounded-pill">Medium</span>
                                {% else %}
                                    <span class="badge bg-success rounded-pill">Low</span>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-secondary rounded-pill">Pending</span>
                            {% endif %}
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Manipulation</span>
                            {% if authenticity_result.found %}
                                {% if authenticity_result.value.confidence_score > 0.7 %}
                                    <span class="badge bg-danger rounded-pill">High</span>
                                {% elif authenticity_result.value.confidence_score > 0.4 %}
                                    <span class="badge bg-warning rounded-pill">Medium</span>
                                {% else %}
                                    <span class="badge bg-success rounded-pill">Low</span>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-secondary rounded-pill">Pending</span>
                            {% endif %}
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Factual Issues</span>
                            {% if factual_result.found %}
                                {% if factual_result.value.confidence_score > 0.7 %}
                                    <span class="badge bg-danger rounded-pill">High</span>
                                {% elif factual_result.value.confidence_score > 0.4 %}
                                    <span class="badge bg-warning rounded-pill">Medium</span>
                                {% else %}
                                    <span class="badge bg-success rounded-pill">Low</span>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-secondary rounded-pill">Pending</span>
                            {% endif %}
                        </li>
                    </ul>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('verification.submit_content') }}" class="btn btn-primary">Submit New Content</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detailed Analysis Results Tabs -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="resultTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="misinformation-tab" data-bs-toggle="tab" data-bs-target="#misinformation" 
                                    type="button" role="tab" aria-controls="misinformation" aria-selected="true">
                                Misinformation
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ai-generated-tab" data-bs-toggle="tab" data-bs-target="#ai-generated" 
                                    type="button" role="tab" aria-controls="ai-generated" aria-selected="false">
                                AI Generated
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="authenticity-tab" data-bs-toggle="tab" data-bs-target="#authenticity" 
                                    type="button" role="tab" aria-controls="authenticity" aria-selected="false">
                                Authenticity
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="factual-tab" data-bs-toggle="tab" data-bs-target="#factual" 
                                    type="button" role="tab" aria-controls="factual" aria-selected="false">
                                Factual Accuracy
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="resultTabsContent">
                        <div class="tab-pane fade show active" id="misinformation" role="tabpanel" aria-labelledby="misinformation-tab">
                            {% set found = False %}
                            {% for result in verification_results %}
                                {% if result.verification_type == 'misinformation' %}
                                    {% set found = True %}
                                    <h4>Misinformation Analysis</h4>
                                    
                                    {% if result.status == 'completed' %}
                                        <div class="alert 
                                            {% if result.confidence_score > 0.7 %}alert-danger
                                            {% elif result.confidence_score > 0.4 %}alert-warning
                                            {% else %}alert-success{% endif %}">
                                            <h5>{{ result.result_summary }}</h5>
                                        </div>
                                        
                                        {% if result.evidence %}
                                            <h5>Evidence:</h5>
                                            <div class="p-3 bg-light rounded mb-3">
                                                <p>{{ result.evidence }}</p>
                                            </div>
                                        {% endif %}
                                        
                                        {% set metadata = result.get_meta_data() %}
                                        {% if metadata and metadata.recommendations %}
                                            <h5>Recommendations:</h5>
                                            <ul class="list-group mb-3">
                                                {% for rec in metadata.recommendations %}
                                                    <li class="list-group-item">{{ rec }}</li>
                                                {% endfor %}
                                            </ul>
                                        {% endif %}
                                        
                                    {% elif result.status == 'processing' %}
                                        <div class="alert alert-info">
                                            <p><i class="fas fa-spinner fa-spin"></i> Analysis in progress... Please check back in a few moments.</p>
                                        </div>
                                    {% elif result.status == 'failed' %}
                                        <div class="alert alert-danger">
                                            <p>Analysis failed: {{ result.result_summary }}</p>
                                        </div>
                                    {% else %}
                                        <div class="alert alert-secondary">
                                            <p>Analysis pending...</p>
                                        </div>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            
                            {% if not found %}
                                <div class="alert alert-info">
                                    <p>No misinformation analysis has been performed yet.</p>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="tab-pane fade" id="ai-generated" role="tabpanel" aria-labelledby="ai-generated-tab">
                            {% set found = False %}
                            {% for result in verification_results %}
                                {% if result.verification_type == 'ai_generated' %}
                                    {% set found = True %}
                                    <h4>AI Generation Analysis</h4>
                                    
                                    {% if result.status == 'completed' %}
                                        <div class="alert 
                                            {% if result.confidence_score > 0.7 %}alert-danger
                                            {% elif result.confidence_score > 0.4 %}alert-warning
                                            {% else %}alert-success{% endif %}">
                                            <h5>{{ result.result_summary }}</h5>
                                        </div>
                                        
                                        {% if result.evidence %}
                                            <h5>Evidence:</h5>
                                            <div class="p-3 bg-light rounded mb-3">
                                                <p>{{ result.evidence }}</p>
                                            </div>
                                        {% endif %}
                                        
                                        {% set metadata = result.get_meta_data() %}
                                        {% if metadata and metadata.recommendations %}
                                            <h5>Recommendations:</h5>
                                            <ul class="list-group mb-3">
                                                {% for rec in metadata.recommendations %}
                                                    <li class="list-group-item">{{ rec }}</li>
                                                {% endfor %}
                                            </ul>
                                        {% endif %}
                                        
                                    {% elif result.status == 'processing' %}
                                        <div class="alert alert-info">
                                            <p><i class="fas fa-spinner fa-spin"></i> Analysis in progress... Please check back in a few moments.</p>
                                        </div>
                                    {% elif result.status == 'failed' %}
                                        <div class="alert alert-danger">
                                            <p>Analysis failed: {{ result.result_summary }}</p>
                                        </div>
                                    {% else %}
                                        <div class="alert alert-secondary">
                                            <p>Analysis pending...</p>
                                        </div>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            
                            {% if not found %}
                                <div class="alert alert-info">
                                    <p>No AI generation analysis has been performed yet.</p>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="tab-pane fade" id="authenticity" role="tabpanel" aria-labelledby="authenticity-tab">
                            {% set found = False %}
                            {% for result in verification_results %}
                                {% if result.verification_type == 'authenticity' %}
                                    {% set found = True %}
                                    <h4>Authenticity Analysis</h4>
                                    
                                    {% if result.status == 'completed' %}
                                        <div class="alert 
                                            {% if result.confidence_score > 0.7 %}alert-danger
                                            {% elif result.confidence_score > 0.4 %}alert-warning
                                            {% else %}alert-success{% endif %}">
                                            <h5>{{ result.result_summary }}</h5>
                                        </div>
                                        
                                        {% if result.evidence %}
                                            <h5>Evidence:</h5>
                                            <div class="p-3 bg-light rounded mb-3">
                                                <p>{{ result.evidence }}</p>
                                            </div>
                                        {% endif %}
                                        
                                        {% set metadata = result.get_meta_data() %}
                                        {% if metadata and metadata.recommendations %}
                                            <h5>Recommendations:</h5>
                                            <ul class="list-group mb-3">
                                                {% for rec in metadata.recommendations %}
                                                    <li class="list-group-item">{{ rec }}</li>
                                                {% endfor %}
                                            </ul>
                                        {% endif %}
                                        
                                    {% elif result.status == 'processing' %}
                                        <div class="alert alert-info">
                                            <p><i class="fas fa-spinner fa-spin"></i> Analysis in progress... Please check back in a few moments.</p>
                                        </div>
                                    {% elif result.status == 'failed' %}
                                        <div class="alert alert-danger">
                                            <p>Analysis failed: {{ result.result_summary }}</p>
                                        </div>
                                    {% else %}
                                        <div class="alert alert-secondary">
                                            <p>Analysis pending...</p>
                                        </div>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            
                            {% if not found %}
                                <div class="alert alert-info">
                                    <p>No authenticity analysis has been performed yet.</p>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="tab-pane fade" id="factual" role="tabpanel" aria-labelledby="factual-tab">
                            {% set found = False %}
                            {% for result in verification_results %}
                                {% if result.verification_type == 'factual_accuracy' %}
                                    {% set found = True %}
                                    <h4>Factual Accuracy Analysis</h4>
                                    
                                    {% if result.status == 'completed' %}
                                        <div class="alert 
                                            {% if result.confidence_score > 0.7 %}alert-danger
                                            {% elif result.confidence_score > 0.4 %}alert-warning
                                            {% else %}alert-success{% endif %}">
                                            <h5>{{ result.result_summary }}</h5>
                                        </div>
                                        
                                        {% if result.evidence %}
                                            <h5>Evidence:</h5>
                                            <div class="p-3 bg-light rounded mb-3">
                                                <p>{{ result.evidence }}</p>
                                            </div>
                                        {% endif %}
                                        
                                        {% set metadata = result.get_meta_data() %}
                                        {% if metadata and metadata.recommendations %}
                                            <h5>Recommendations:</h5>
                                            <ul class="list-group mb-3">
                                                {% for rec in metadata.recommendations %}
                                                    <li class="list-group-item">{{ rec }}</li>
                                                {% endfor %}
                                            </ul>
                                        {% endif %}
                                        
                                    {% elif result.status == 'processing' %}
                                        <div class="alert alert-info">
                                            <p><i class="fas fa-spinner fa-spin"></i> Analysis in progress... Please check back in a few moments.</p>
                                        </div>
                                    {% elif result.status == 'failed' %}
                                        <div class="alert alert-danger">
                                            <p>Analysis failed: {{ result.result_summary }}</p>
                                        </div>
                                    {% else %}
                                        <div class="alert alert-secondary">
                                            <p>Analysis pending...</p>
                                        </div>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            
                            {% if not found %}
                                <div class="alert alert-info">
                                    <p>No factual accuracy analysis has been performed yet.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Auto-refresh the page if any verifications are still processing
    document.addEventListener('DOMContentLoaded', function() {
        const hasProcessing = Array.from(document.querySelectorAll('.alert-info')).some(
            el => el.textContent.includes('Analysis in progress')
        );
        
        if (hasProcessing) {
            setTimeout(function() {
                window.location.reload();
            }, 10000); // Refresh every 10 seconds if processing
        }
    });
</script>
{% endblock %}