{% extends 'base.html' %}

{% block title %}Search & Monitor - CIVILIAN{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mt-4 mb-4">Search & Monitor</h1>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Search for Content</h5>
                </div>
                <div class="card-body">
                    <p>
                        Search for web content related to specific terms and set up continuous 
                        monitoring for these topics. The system will collect and analyze related 
                        information for misinformation narratives.
                    </p>
                    
                    <form id="search-form">
                        <div class="mb-3">
                            <label for="search_term" class="form-label">Search Term</label>
                            <input type="text" class="form-control" id="search_term" name="search_term" 
                                   placeholder="Enter search term" required>
                            <div class="form-text">Be specific to get more relevant results</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="category" name="category">
                                <option value="misinformation" selected>Misinformation</option>
                                <option value="emerging_narratives">Emerging Narratives</option>
                                <option value="security_threats">Security Threats</option>
                                <option value="political">Political</option>
                                <option value="health">Health</option>
                                <option value="science">Science</option>
                                <option value="technology">Technology</option>
                                <option value="custom">Custom</option>
                            </select>
                            <div class="form-text">Categorize this search term for better organization</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="limit" class="form-label">Result Limit</label>
                            <select class="form-select" id="limit" name="limit">
                                <option value="5">5 results</option>
                                <option value="10" selected>10 results</option>
                                <option value="20">20 results</option>
                                <option value="50">50 results (may take longer)</option>
                            </select>
                            <div class="form-text">Maximum number of results to retrieve</div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Search & Monitor
                        </button>
                        
                        <a href="{{ url_for('web_scraping.index') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back
                        </a>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row d-none" id="search-status-container">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Search Status</h5>
                </div>
                <div class="card-body" id="search-status">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border text-primary me-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>
                            <h5 class="mb-0">Processing your search request...</h5>
                            <p class="text-muted mb-0">This may take a few moments.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row d-none" id="search-results-container">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Search Results</h5>
                </div>
                <div class="card-body" id="search-results">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Current Monitoring Terms</h5>
                </div>
                <div class="card-body" id="monitoring-terms">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchForm = document.getElementById('search-form');
        const searchStatusContainer = document.getElementById('search-status-container');
        const searchResultsContainer = document.getElementById('search-results-container');
        const searchResultsDiv = document.getElementById('search-results');
        const monitoringTermsDiv = document.getElementById('monitoring-terms');
        
        // Fetch existing monitoring terms
        fetch('/web-scraping/status')
            .then(response => response.json())
            .then(data => {
                updateMonitoringTerms(data.search_term_stats);
            })
            .catch(error => {
                console.error('Error fetching monitoring terms:', error);
                monitoringTermsDiv.innerHTML = 
                    '<div class="alert alert-danger">Error loading monitoring terms</div>';
            });
        
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get form data
            const searchTerm = document.getElementById('search_term').value;
            const category = document.getElementById('category').value;
            const limit = document.getElementById('limit').value;
            
            // Show status container
            searchStatusContainer.classList.remove('d-none');
            searchResultsContainer.classList.add('d-none');
            
            // Send search request
            fetch('/web-scraping/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    search_term: searchTerm,
                    category: category,
                    limit: parseInt(limit)
                })
            })
            .then(response => response.json())
            .then(data => {
                // Process results
                if (data.status === 'processing') {
                    setTimeout(() => {
                        showSearchSuccess(searchTerm, category);
                    }, 3000);
                } else if (data.error) {
                    showError('Search failed: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error performing search:', error);
                showError('Error performing search: ' + error.message);
            });
        });
        
        function showSearchSuccess(searchTerm, category) {
            searchStatusContainer.classList.add('d-none');
            searchResultsContainer.classList.remove('d-none');
            
            let resultsHtml = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> Search term added to monitoring!
                </div>
                
                <div class="mb-4">
                    <p>
                        The search term <strong>"${searchTerm}"</strong> has been added to the 
                        <strong>${category}</strong> category for continuous monitoring.
                    </p>
                    
                    <p>
                        The system will collect and analyze content related to this term in the background.
                        Results will appear in the narrative detection system as they are processed.
                    </p>
                    
                    <div class="mt-4">
                        <a href="{{ url_for('web_scraping.monitoring') }}" class="btn btn-primary">
                            <i class="fas fa-cog"></i> Manage Monitoring
                        </a>
                        
                        <button class="btn btn-outline-primary ms-2" onclick="window.location.reload()">
                            <i class="fas fa-plus"></i> Add Another Term
                        </button>
                    </div>
                </div>
            `;
            
            searchResultsDiv.innerHTML = resultsHtml;
            
            // Refresh monitoring terms
            fetch('/web-scraping/status')
                .then(response => response.json())
                .then(data => {
                    updateMonitoringTerms(data.search_term_stats);
                });
        }
        
        function showError(errorMessage) {
            searchStatusContainer.classList.add('d-none');
            searchResultsContainer.classList.remove('d-none');
            
            searchResultsDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i> ${errorMessage}
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="window.location.reload()">
                        <i class="fas fa-sync"></i> Try Again
                    </button>
                </div>
            `;
        }
        
        function updateMonitoringTerms(termStats) {
            const categories = termStats.terms_by_category || {};
            const recentTerms = termStats.recently_processed || [];
            
            let termsHtml = '';
            
            // Check if there are any terms
            const totalTerms = termStats.total_terms || 0;
            
            if (totalTerms === 0) {
                termsHtml = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No monitoring terms have been added yet.
                        Use the form above to add search terms for monitoring.
                    </div>
                `;
            } else {
                // Show categories
                termsHtml += `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Categories</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Category</th>
                                            <th>Terms</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                for (const [category, count] of Object.entries(categories)) {
                    termsHtml += `
                        <tr>
                            <td>${category.charAt(0).toUpperCase() + category.slice(1)}</td>
                            <td>${count}</td>
                        </tr>
                    `;
                }
                
                termsHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6>Recently Processed Terms</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Term</th>
                                            <th>Last Processed</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                for (const term of recentTerms) {
                    termsHtml += `
                        <tr>
                            <td>${term.term || 'N/A'}</td>
                            <td>${formatDate(term.last_ingestion)}</td>
                        </tr>
                    `;
                }
                
                termsHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            monitoringTermsDiv.innerHTML = termsHtml;
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            
            const date = new Date(dateStr);
            return date.toLocaleString();
        }
    });
</script>
{% endblock %}